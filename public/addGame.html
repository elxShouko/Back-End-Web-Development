<!-- 
    Class: DIT/1B/03
    Admission Number: P2026453
    Name: Phan Kiah Fong Nicholas
 -->

<!DOCTYPE html>

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SP Games</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="css/addGame.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script>
        // function createCard(cardInfo) {
        //     var card = `
        //     <div class="card" style="margin-top: 2rem;">
        //         <div class="card-body">
        //             <p class="card-text">${cardInfo.title}</p> 
        //         </div>
        //         <div class="card-footer text-muted">
        //             ${cardInfo.platform} 
        //             </div>
        //         <div class="card-footer text-muted">
        //             <a href="https://viewGames.html?gameid=${cardInfo.price}"
        //                 class="btn btn-primary">View</a>

        //         </div>
        //     </div>
        //     `;
        //     /*
        //         href = "viewUsers.html"
        //         href = "/viewUsers.html"

        //         href      |      Current location       |   Target Location
        //         -------------------------------------------------
        //         a.html    |http://abc.com/page1.html    |http://abc.com/a.html
        //         /a.html   |http://abc.com.page1.html    |http://abc.com/a.html
        //         a.html    |http://abc.com/sub/page1.html|http://abc.com/sub/a.html
        //         /a.html   |http://abc.com/sub/page1.html|http://abc.com/a.html

        //         login.html    http://abc.com/catalog/products.html   http://abc.com/catalog/login.html
        //         /login.html   http://abc.com/catalog/products.html   http://abc.com/login.html

        //         We use a / infront because it directs us to the root folder when we change pages

        //         http://abc.com/games.html?id=132
        //         http://abc.com/game?id=132
        //         anything that goes behind the question mark extracts the value and use it for other pages (Query Parameters)
        //     */

        //     return card
        // }

        function createCard(cardInfo) {
            var card = `
            <div class="card" style="margin-top: 2rem;">
                <div class="card-body">
                    <p class="card-text">${cardInfo.title}</p> 
                </div>
                <div class="card-footer text-muted">
                    ${cardInfo.description} 
                    </div>
                <div class="card-footer text-muted">
                    <a href="http://localhost:3001/viewGame.html?gameid=${cardInfo.gameid}"
                        class="btn btn-primary">View</a>

                </div>
            </div>
            `;
            /*
                href = "viewUsers.html"
                href = "/viewUsers.html"

                href      |      Current location       |   Target Location
                -------------------------------------------------
                a.html    |http://abc.com/page1.html    |http://abc.com/a.html
                /a.html   |http://abc.com.page1.html    |http://abc.com/a.html
                a.html    |http://abc.com/sub/page1.html|http://abc.com/sub/a.html
                /a.html   |http://abc.com/sub/page1.html|http://abc.com/a.html

                login.html    http://abc.com/catalog/products.html   http://abc.com/catalog/login.html
                /login.html   http://abc.com/catalog/products.html   http://abc.com/login.html
                
                We use a / infront because it directs us to the root folder when we change pages

                http://abc.com/games.html?id=132
                http://abc.com/game?id=132
                anything that goes behind the question mark extracts the value and use it for other pages (Query Parameters)
            */

            return card
        }

        function createPanel(panelInfo) {
            var panel = `
            <option value="${panelInfo.id}">${panelInfo.catname}</option>
            `;

            return panel
        }


        // function addGame(title, description, price, platform, categoryid, categoryid2, year) {
        //     // call the web service endpoint
        //     $.ajax({
        //         // headers: { 'authorization': 'Bearer ' + tmpToken },

        //         url: 'http://localhost:3000/game/' + title + '/' + platform + '/' + price, // to get value of gameid, 

        //         type: 'GET',
        //         // data: JSON.stringify(data2),
        //         // contentType: "application/json; charset=utf-8",
        //         dataType: 'json',
        //         success: function (data, textStatus, xhr) { // data would store the responses when user succeeds in updating a user 
        //             // to use data, use data.fieldCount, data.affectedRows etc...
        //             // console.log("---------response data-----------");

        //             // console.log("TESTTESTEST")
        //             console.log(data);

        //             if (data.length == 0) {
        //                 console.log("No game found in Search");
        //                 $('#messages').html("No results. Cannot find game."); // Writes to html that no game is found
        //                 loadAllGames();
        //                 return;
        //             }

        //             for (var i = 0; i < data.length; i++) {
        //                 var cardInfo = {
        //                     "title": data[i].title,
        //                     "description": data[i].description,
        //                     "platform": data[i].platform,
        //                     "price": data[i].price
        //                 }

        //                 var cardHtml = createCard(cardInfo);

        //                 $('#games').append(cardHtml);
        //             }


        //             // //| 
        //             // $('#title').html(data[0].title);     //|----- gets the user's data
        //             // $('#platform').html(data[0].platform);
        //             // $('#price').html(data[0].price);
        //             // //|



        //         },
        //         error: function (xhr, textStatus, errorThrown) {
        //             console.log('Error in Operation');
        //             console.log(xhr);
        //             console.log(textStatus);
        //             console.log(errorThrown);

        //             console.log(xhr.responseText);
        //             console.log(xhr.status);
        //             // if (xhr.status == 401) {
        //             //     $('#msg').html('Yo! Unauthorised Lah!!'); // Message shown in the front end
        //             // }
        //         }
        //     });

        // }

        function loadAllCategories() {
            // call the web service endpoint
            $.ajax({
                // headers: { 'authorization': 'Bearer ' + tmpToken },
                url: 'http://localhost:3000/getAllCategories',
                type: 'GET',
                // data: JSON.stringify(data2),
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (data, textStatus, xhr) { // data would store the responses when user succeeds in updating a user 
                    // to use data, use data.fieldCount, data.affectedRows etc...
                    console.log("---------response data-----------");
                    console.log(data);
                    for (var i = 0; i < data.length; i++) {
                        var categories = data[i];
                        // console.log("userid: "+user.userid);
                        // console.log("username: "+user.username);
                        // console.log("email: "+user.email);

                        // compile the data that the card needs for its creation
                        var panelInfo = {
                            id: categories.id,
                            catname: categories.catname,
                        };
                        console.log("-------------Card Info data pack---------------");
                        console.log(panelInfo);

                        var newPanel = createPanel(panelInfo);
                        $('#category').append(newPanel);
                        $('#category2').append(newPanel);
                    }
                    // if (data != null && data.success) {

                    //     $('#msg').html('Record updated successfully!');
                    //     console.log(xhr.responseText)

                    // } else {
                    //     console.log("Error");
                    // }
                },
                error: function (xhr, textStatus, errorThrown) {
                    console.log('Error in Operation');
                    console.log(xhr);
                    console.log(textStatus);
                    console.log(errorThrown);

                    console.log(xhr.responseText);
                    console.log(xhr.status);
                    // if (xhr.status == 401) {
                    //     $('#msg').html('Yo! Unauthorised Lah!!'); // Message shown in the front end
                    // }
                }
            });
        }


        $(document).ready(function () {

            const token = localStorage.getItem("token");
            const userInfo = localStorage.getItem("userInfo");

            if (token === null || userInfo === null) { // no token no userInfo
                console.log("Token not found / No User ID... redirecting to Login")
                window.location.href = "/login.html"; // to kick user out of restricted page
            }
            const userInfoJSON = JSON.parse(userInfo)[0];
            if (token != null && userInfoJSON.type != "Admin") { // there's token and is not admin
                window.location.href = "/home.html";
            }

            $("#AddGame").click(function () {
                // data extraction
                var tmpTitle = $('#titleText').val();
                var tmpDesc = $('#descriptionText').val();
                var tmpPrice = $('#priceText').val();
                var tmpPlatform = $('#platformText').val();
                var tmpCat1 = $('#category').val();
                var tmpCat2 = $('#category2').val();
                var tmpYear = $('#yearText').val();
                // var userid = localStorage.getItem('userInfo')[0].userid

                // var userData = localStorage.getItem('userInfo');
                // var userJsonData = JSON.parse(userData);
                // var userid = userJsonData[0].userid;
                // var tmpPwd = userJsonData[0].password;
                // console.log("userid: " + userid);

                // data compilation
                // var data = "{\"username\":\"" + tmpUName + "\", \"email\":\"" + tmpEmail + "\", \"role\":\"" + tmpRole + "\", \"password\":\""+ tmpPwd +"\"}";


                // console.log("Data: " + data);

                // data compilation - better approach
                var data2 = {
                    "title": tmpTitle,
                    "description": tmpDesc,
                    "price": tmpPrice,
                    "platform": tmpPlatform,
                    "categoryid": tmpCat1,
                    "categoryid2": tmpCat2,
                    "year": tmpYear,
                }

                console.log("Data2: " + JSON.stringify(data2));

                // call the web service endpoint
                $.ajax({
                    headers: { 'authorization': 'Bearer ' + token },
                    url: 'http://localhost:3000/addGame',
                    type: 'POST',
                    data: JSON.stringify(data2),
                    contentType: "application/json; charset=utf-8",
                    dataType: 'json',
                    success: function (data, textStatus, xhr) { // data would store the responses when user succeeds in updating a user 
                        // to use data, use data.fieldCount, data.affectedRows etc...
                        if (data != null && data.success) {

                            $('#msg').html('Record updated successfully!');
                            console.log(xhr.responseText)

                        } else {
                            console.log("Error");
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        console.log('Error in Operation');
                        console.log(xhr);
                        console.log(textStatus);
                        console.log(errorThrown);

                        console.log(xhr.responseText);
                        console.log(xhr.status);
                        if (xhr.status == 401) {
                            $('#msg').html('Yo! Unauthorised Lah!!'); // Message shown in the front end
                        }
                    }
                });
            });

            loadAllCategories();
        })

    </script>
</head>

<body>
    <section id="headBackground" class="">
        <p class="h1 text-center" id="sp"><b>Singapore Polytechnic</b></p>
    </section>

    <div class="navbar">
        <a href="home.html" class="table-bordered"><b>Home</b></a>
        <a href="viewGames.html" class="table-bordered"><b>Games</b></a>
        <a href="about.html" class="table-bordered"><b>About</b></a>
        <a href="profile.html" class="table-bordered"><b>Profile</b></a>
        <a href="login.html" class="table-bordered"><b>Log In</b></a>

    </div>
    <div>
        <a href="addGame.html" id="addGameLink">Add Game (Admin Only)</a>
        <a href="addCategory.html" id="addCategoryLink">Add Category (Admin Only)</a>
    </div>

    <form id="search-game-form" style="margin-top: 2rem;">
        <div class="form-group">
            <p id="title">Game Title*:</p>
            <textarea class="form-control" id="titleText" rows="2" placeholder="Title? "></textarea>
            <p id="description">Description*:</p>
            <textarea class="form-control" id="descriptionText" rows="2" placeholder="Description?"></textarea>
            <p id="price">Price*:</p>
            <textarea class="form-control" id="priceText" rows="2" placeholder="Price?"></textarea>
            <p id="platform">Platform*:</p>
            <textarea class="form-control" id="platformText" rows="2" placeholder="Platform?"></textarea>

            


            <label for="cat">Choose a category:</label>
            <select name="cat" id="category">
            </select>

            <label for="cat">Choose a second category:</label>
            <select name="cat" id="category2">
            </select>

            <!-- <textarea class="form-control" id="catidText" rows="2" placeholder="Categoryid?"></textarea> -->
            
            <!-- <textarea class="form-control" id="catid2Text" rows="2" placeholder="Categoryid2?"></textarea> -->
            <p id="year">Year*:</p>
            <textarea class="form-control" id="yearText" rows="2" placeholder="Year?"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" id="AddGame">Add Game</button>
    </form>


</body>

<footer>

    Copyright &#9400; 2020, All rights reserved.
    SP_Games
</footer>

</html>